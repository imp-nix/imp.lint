#!/usr/bin/env bash
# Pre-commit hook to auto-format staged files and run lints

set -e

# Check if treefmt is available
if ! command -v treefmt &> /dev/null; then
    echo "treefmt not found. Run 'nix develop' to enter the dev shell."
    exit 1
fi

# Get list of staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$staged_files" ]; then
    exit 0
fi

# Run clippy auto-fix first (before lint scan)
if command -v cargo &> /dev/null; then
    echo "Running clippy auto-fix..."
    cargo clippy --all-targets --all-features --fix --allow-dirty --allow-staged 2>/dev/null || true
fi

# Run consolidated lint scan
if command -v lint &> /dev/null; then
    echo "Running lint scan..."
    if ! lint; then
        echo "Lint scan found issues. Please fix them before committing."
        exit 1
    fi
else
    echo "Warning: lint command not found, skipping lint scan."
fi

# Run treefmt on staged files
echo "Running treefmt on staged files..."
echo "$staged_files" | xargs treefmt --no-cache

# Re-add any files that were modified by treefmt
echo "$staged_files" | while read -r file; do
    if [ -f "$file" ]; then
        git add "$file"
    fi
done

echo "Formatting complete."
